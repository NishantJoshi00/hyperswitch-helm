<source>
  @type tail
  @id in_tail_hyperswitch-server-router_logs

  path /var/log/containers/hyperswitch-*.log
  pos_file /var/log/fluentd-hyperswitch-server-router-containers.log.pos
  tag "hyperswitch.*"
  read_from_head true
  <parse>
    @type regexp
    expression /^(?<time>.+) (?<stream>stdout|stderr)( (?<logtag>.))? (?<log>.*)$/
  </parse>
</source>

<match hyperswitch.**>
    <format>
      @type json
    </format>
    @type copy
    <store>
      @type stdout
    </store>
    <store>
      @type s3
      s3_bucket "#{ENV['S3_BUCKET']}"
      s3_region "#{ENV['S3_REGION']}"
      path hyperswitch-logs/
      <buffer tag,time>
        @type file
        path /var/log/fluent/s3
        timekey 3600 # 1 hour partition
        timekey_wait 10m
        timekey_zone +0530
        chunk_limit_size 256m
        flush_at_shutdown
      </buffer>
    </store>
</match>